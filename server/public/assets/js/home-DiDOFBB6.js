import{H as e,J as a,K as l,r as o,L as t,o as i,c as u,b as s,e as n,f as d,B as r,j as c,k as v,N as p,O as m,P as f,Q as _,R as y,T as h,U as b,V as w,W as k,m as C,n as V,X as g,t as x,u as T,Y as U,q as $,_ as F,$ as B,a0 as I,a1 as K,a2 as M,a3 as z,a4 as A,a5 as S,a6 as j,a7 as N,a8 as D,i as E,a9 as L}from"./vendor-CRD7CLCO.js";import{_ as R,u as X,i as Y}from"./index-WwQmHM_O.js";const q={class:"home-container"},G={class:"operation-bar"},H=R({__name:"home",setup(R){const{proxy:H}=l();X();const J=T(),O=o(!1),P=o(""),Q=o([]),W=o(!1),Z=o(""),ee=o(!1),ae=o([]),le=o([]),oe=o(null),te=o(""),ie=o(!1),ue=o(null),se=o(!1),ne=o({expireTime:7,codeType:"random",code:""}),de=[{label:"1天",value:1},{label:"7天",value:7},{label:"30天",value:30},{label:"365天",value:365},{label:"永久",value:-1}],re=[{colKey:"name",title:"文件名",width:"40%"},{colKey:"size",title:"大小",width:"15%"},{colKey:"createdAt",title:"创建时间",width:"20%"},{colKey:"op",title:"操作",width:"25%"}],ce=o(!1),ve=o(null),pe=()=>Math.random().toString(36).substr(2,4).toUpperCase(),me=e=>{"custom"===e?ne.value.code="":_e()},fe=t((()=>"random"===ne.value.codeType?pe():ne.value.code)),_e=()=>{ne.value.code=pe()},ye=async()=>{try{const l="random"===ne.value.codeType?fe.value:ne.value.code,{data:o}=await Y.post(`/api/files/${ue.value._id}/share`,{expireTime:ne.value.expireTime,code:l});if(o){(l=>{const o=document.createElement("button");o.style.display="none",document.body.appendChild(o);const t=new e(o,{text:()=>l});t.on("success",(e=>{e.clearSelection(),a.success("链接已复制到剪贴板"),t.destroy(),document.body.removeChild(o)})),t.on("error",(()=>{a.error("复制失败, 请检查当前浏览器是否支持Clipboard.js"),t.destroy(),document.body.removeChild(o)})),o.click()})(`链接: ${window.location.origin}/share/${o.shareId} 提取码: ${l}`),se.value=!1}}catch(l){a.error("分享失败")}},he=async()=>{try{const{data:e}=await Y.post(`/api/files/${ue.value._id}/share`,{expireTime:ne.value.expireTime,code:ne.value.code});a.success("分享成功");const l=`${window.location.origin}/share/${e.shareId}`;await navigator.clipboard.writeText(l),a.success("分享链接已复制到剪贴板")}catch(e){a.error("分享失败")}finally{se.value=!1}},be=()=>{ee.value=!0,ae.value=[]},we=async(e,l)=>{if(ae.value=l.currentSelectedFiles,0===ae.value.length)return a.error("请选择要上传的文件"),!1;try{for(const e of ae.value){const a=new FormData;a.append("file",e.raw),oe.value&&a.append("parentId",oe.value);try{await Y.post("/api/files/upload",a),e.status="success"}catch(o){e.status="fail"}}await Ke(oe.value)}catch(o){a.error("上传文件失败")}},ke=async e=>{try{const{data:a}=await Y.post(`/api/files/download/${e._id}`);L.saveAs(a.url,a.filename)}catch(l){a.error("下载失败")}},Ce=async e=>{try{await Y.delete(`/api/files/${e._id}`),a.success("删除成功"),await Ke(oe.value)}catch(l){a.error("删除失败")}},Ve=async()=>{if(P.value){O.value=!0;try{const{data:e}=await Y.get("/api/files/search",{params:{keyword:P.value}});le.value=e,a.success("搜索完成")}catch(e){console.log(e),a.error("搜索失败")}finally{O.value=!1}}else await Ke(oe.value)},ge=(e,a)=>{H.$contextmenu({x:e.clientX,y:e.clientY,items:[{label:"打开",icon:"folder",onClick:()=>{a.isFolder&&Ae(a._id)},disabled:!a.isFolder},{label:"下载",icon:"download",onClick:()=>ke(a),disabled:a.isFolder},{label:"分享",icon:"share",onClick:()=>{return e=a,ue.value=e,ne.value={expireTime:7,codeType:"random",code:pe()},void(se.value=!0);var e}},{label:"复制",icon:"copy",onClick:()=>xe(a)},{label:"移动",icon:"move",onClick:()=>Te(a)},{label:"重命名",icon:"edit",onClick:()=>$e(a)},{label:"删除",icon:"delete",onClick:()=>Ce(a)}]})},xe=async e=>{try{await Y.post(`/api/files/${e._id}/copy`),await Ke(oe.value),a.success("复制成功")}catch(l){a.error("复制失败")}},Te=async e=>{ce.value=!0,ue.value=e},Ue=async()=>{if(ve.value)try{await Y.post(`/api/files/${ue.value._id}/move`,{targetFolderId:ve.value}),a.success("移动成功"),await Ke(oe.value)}catch(e){a.error("移动失败")}finally{ce.value=!1}else a.warning("请选择目标文件夹")},$e=async e=>{te.value=e.originalName,ie.value=!0,ue.value=e},Fe=async()=>{try{await Y.post(`/api/files/${ue.value._id}/rename`,{newName:te.value}),a.success("重命名成功"),await Ke(oe.value)}catch(e){a.error("重命名失败")}finally{ie.value=!1}},Be=t((()=>{const e=(a,l=null)=>a.filter((e=>e.isFolder&&e.parent===l)).map((l=>({...l,children:e(a,l._id)})));return e(le.value)})),Ie=e=>{ve.value=e},Ke=async(e=null)=>{O.value=!0;try{const{data:a}=await Y.post("/api/files/list",{parentId:e});le.value=a,oe.value=e}catch(l){a.error("加载文件列表失败")}finally{O.value=!1}},Me=()=>{W.value=!0,Z.value=""},ze=async()=>{if(Z.value)try{await Y.post("/api/files/folder",{name:Z.value,parentId:oe.value}),a.success("创建成功"),await Ke(oe.value)}catch(e){a.error("创建失败")}finally{W.value=!1}else a.warning("请输入文件夹名称")},Ae=async e=>{if(e){const a=le.value.find((a=>a._id===e));a&&Q.value.push(a)}else Q.value=[];await Ke(e)},Se=e=>{if(0===e)return"0 B";const a=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,a)).toFixed(2))+" "+["B","KB","MB","GB","TB"][a]};return i((()=>{Ke()})),(e,a)=>{const l=r,o=f,t=_,i=h,T=k,L=B,R=I,X=K,Y=M,H=j,oe=S,ue=A,ve=z,pe=D;return E(),u("div",q,[s("div",G,[n(o,null,{default:d((()=>[n(l,{theme:"primary",onClick:be},{icon:d((()=>[n(v(p))])),default:d((()=>[a[15]||(a[15]=c(" 上传文件 "))])),_:1,__:[15]}),n(l,{onClick:Me},{icon:d((()=>[n(v(m))])),default:d((()=>[a[16]||(a[16]=c(" 新建文件夹 "))])),_:1,__:[16]})])),_:1}),n(o,null,{default:d((()=>[n(t,{modelValue:P.value,"onUpdate:modelValue":a[0]||(a[0]=e=>P.value=e),placeholder:"搜索文件",clearable:"",onEnter:Ve},{"prefix-icon":d((()=>[n(v(y))])),_:1},8,["modelValue"])])),_:1})]),n(T,{class:"breadcrumb"},{default:d((()=>[n(i,{onClick:a[1]||(a[1]=e=>Ae(null))},{default:d((()=>a[17]||(a[17]=[c("根目录")]))),_:1,__:[17]}),(E(!0),u(b,null,w(Q.value,(e=>(E(),C(i,{key:e._id,onClick:a=>Ae(e._id)},{default:d((()=>[c(x(e.name),1)])),_:2},1032,["onClick"])))),128))])),_:1}),n(L,{data:le.value,"row-key":"_id",columns:re,loading:O.value,hover:""},{name:d((({row:e})=>[n(o,{onContextmenu:g((a=>ge(a,e)),["prevent"]),onClick:()=>{e.isFolder?Ae(e._id):v(J).push(`/file/${e._id}`)}},{default:d((()=>[(E(),C(U(e.isFolder?v($):v(F)))),c(" "+x(e.originalName),1)])),_:2},1032,["onContextmenu","onClick"])])),size:d((({row:e})=>[c(x(Se(e.size)),1)])),createdAt:d((({row:e})=>{return[c(x((a=e.createdAt,new Date(a).toLocaleString())),1)];var a})),op:d((({row:e})=>[n(o,null,{default:d((()=>[e.isFolder?V("",!0):(E(),C(l,{key:0,theme:"primary",variant:"text",onClick:g((a=>ke(e)),["stop"])},{default:d((()=>a[18]||(a[18]=[c(" 下载 ")]))),_:2,__:[18]},1032,["onClick"])),n(l,{theme:"danger",variant:"text",onClick:g((a=>Ce(e)),["stop"])},{default:d((()=>a[19]||(a[19]=[c("删除")]))),_:2,__:[19]},1032,["onClick"])])),_:2},1024)])),_:1},8,["data","loading"]),n(R,{visible:W.value,"onUpdate:visible":a[3]||(a[3]=e=>W.value=e),header:"新建文件夹","on-confirm":ze},{default:d((()=>[n(t,{modelValue:Z.value,"onUpdate:modelValue":a[2]||(a[2]=e=>Z.value=e),placeholder:"请输入文件夹名称"},null,8,["modelValue"])])),_:1},8,["visible"]),n(Y,{visible:ee.value,"onUpdate:visible":a[5]||(a[5]=e=>ee.value=e),size:"large","destroy-on-close":"",lazy:"",footer:!1,header:"上传文件"},{default:d((()=>[n(X,{modelValue:ae.value,"onUpdate:modelValue":a[4]||(a[4]=e=>ae.value=e),theme:"file-flow",onSelectChange:we,multiple:""},null,8,["modelValue"])])),_:1},8,["visible"]),n(R,{visible:se.value,"onUpdate:visible":a[11]||(a[11]=e=>se.value=e),header:"分享文件","on-confirm":he,"close-on-overlay-click":!1},{footer:d((()=>[n(o,null,{default:d((()=>[n(l,{onClick:a[10]||(a[10]=e=>se.value=!1)},{default:d((()=>a[23]||(a[23]=[c("取消")]))),_:1,__:[23]}),n(l,{theme:"primary",class:"copy",onClick:ye},{default:d((()=>a[24]||(a[24]=[c("生成分享链接")]))),_:1,__:[24]})])),_:1})])),default:d((()=>[n(ve,{data:ne.value,ref:"shareFormRef",labelAlign:"top"},{default:d((()=>[n(ue,{label:"分享有效期"},{default:d((()=>[n(oe,{modelValue:ne.value.expireTime,"onUpdate:modelValue":a[6]||(a[6]=e=>ne.value.expireTime=e)},{default:d((()=>[(E(),u(b,null,w(de,(e=>n(H,{value:e.value},{default:d((()=>[c(x(e.label),1)])),_:2},1032,["value"]))),64))])),_:1},8,["modelValue"])])),_:1}),n(ue,{label:"提取码"},{default:d((()=>[n(oe,{modelValue:ne.value.codeType,"onUpdate:modelValue":a[7]||(a[7]=e=>ne.value.codeType=e),onChange:me},{default:d((()=>[n(H,{value:"random"},{default:d((()=>a[20]||(a[20]=[c("随机生成")]))),_:1,__:[20]}),n(H,{value:"custom"},{default:d((()=>a[21]||(a[21]=[c("自定义")]))),_:1,__:[21]})])),_:1},8,["modelValue"])])),_:1}),n(ue,null,{default:d((()=>["custom"===ne.value.codeType?(E(),C(t,{key:0,modelValue:ne.value.code,"onUpdate:modelValue":a[8]||(a[8]=e=>ne.value.code=e),placeholder:"请输入4位提取码",maxlength:4},null,8,["modelValue"])):(E(),C(t,{key:1,modelValue:ne.value.code,"onUpdate:modelValue":a[9]||(a[9]=e=>ne.value.code=e),readonly:"",value:fe.value,class:"custom-input"},null,8,["modelValue","value"])),"random"===ne.value.codeType?(E(),C(l,{key:2,onClick:_e},{icon:d((()=>[n(v(N))])),default:d((()=>[a[22]||(a[22]=c(" 重置 "))])),_:1,__:[22]})):V("",!0)])),_:1})])),_:1},8,["data"])])),_:1},8,["visible"]),n(R,{visible:ie.value,"onUpdate:visible":a[13]||(a[13]=e=>ie.value=e),header:"重命名","on-confirm":Fe},{default:d((()=>[n(t,{modelValue:te.value,"onUpdate:modelValue":a[12]||(a[12]=e=>te.value=e),placeholder:"请输入新文件名"},null,8,["modelValue"])])),_:1},8,["visible"]),n(R,{visible:ce.value,"onUpdate:visible":a[14]||(a[14]=e=>ce.value=e),header:"移动到","on-confirm":Ue},{default:d((()=>[n(pe,{data:Be.value,keys:{value:"_id",label:"name",children:"children"},onChange:Ie},null,8,["data"])])),_:1},8,["visible"])])}}},[["__scopeId","data-v-6bb15f20"]]);export{H as default};
